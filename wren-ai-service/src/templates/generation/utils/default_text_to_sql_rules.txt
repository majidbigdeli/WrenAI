
### SQL SERVER (T-SQL) RULES ###
- Target dialect: SQL Server 2019 or later (T-SQL). Do NOT use PostgreSQL/MySQL syntax.
- ONLY USE SELECT statements; never generate INSERT/UPDATE/DELETE or DDL.
- ONLY USE the tables and columns mentioned in the database schema.
- Select explicit columns; use * ONLY when the user explicitly requests all columns.
- Qualify identifiers with schema when provided (e.g., dbo.TableName). Use square brackets for identifiers that need quoting; do NOT use double quotes for identifiers.
- Use single quotes for string literals; never quote numeric literals.
- When selecting from multiple tables, YOU MUST USE explicit JOINs and proper ON conditions.
- Prefer CTEs over deeply nested subqueries when shaping intermediate results.
- Use TOP (N) or TOP (@n) to limit rows. For pagination use ORDER BY ... OFFSET @offset ROWS FETCH NEXT @pageSize ROWS ONLY. Do NOT use LIMIT, RETURNING, ILIKE, SERIAL, ARRAY_AGG, or other non–SQL Server syntax.
- For case-insensitive matching, use LIKE with optional LOWER() if needed by collation; include '%' wildcards for partial matches. Example: LOWER(t.Column) LIKE LOWER('%value%').
- Safe casting/conversion: prefer TRY_CONVERT or TRY_CAST for user-provided values. Example: TRY_CONVERT(int, t.ColInt).
- Date/time handling:
  - Prefer DATETIME2 or DATETIMEOFFSET types.
  - Use DATEADD and DATEDIFF for arithmetic; use EOMONTH and DATEFROMPARTS when appropriate.
  - Avoid INTERVAL, EXTRACT, TO_CHAR/TO_TIMESTAMP, and TIMESTAMP WITH TIME ZONE syntax.
  - For timezone shifts use SWITCHOFFSET/TODATETIMEOFFSET when applicable.
  - For single-day filters, use >= start-of-day AND < DATEADD(day, 1, start-of-day).
- Aggregations belong in HAVING, not WHERE.
- String aggregation: use STRING_AGG(expression, ',') WITHIN GROUP (ORDER BY ... ) when ordering is required.
- Window/ranking problems: use DENSE_RANK()/ROW_NUMBER()/RANK() as appropriate; include the ranking column in the final SELECT and filter with an outer query/WHERE on the rank when needed.
- JSON handling: use JSON_VALUE/JSON_QUERY for extraction; use OPENJSON when parsing arrays/objects; use FOR JSON for serialization.
- Avoid comments in generated SQL.
- Do NOT generate FILTER(WHERE ...), EXTRACT(...), INTERVAL-like expressions, or other non–T-SQL constructs.
- Use table/column aliases without dots (replace '.' with '_'); keep aliases meaningful and consistent across the query.
- Validation before returning the SQL:
  - Ensure no LIMIT/RETURNING/ILIKE/TO_CHAR/INTERVAL/EXTRACT syntax remains.
  - Ensure TOP or OFFSET/FETCH is used for row limits when needed.
  - Ensure schema-qualified identifiers (e.g., dbo.) are used when available and aliases are consistent.
